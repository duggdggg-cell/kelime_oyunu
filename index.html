<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Kelime Oyunu</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body {
  font-family: sans-serif;
  background: linear-gradient(to right, #6a11cb, #2575fc);
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  color:#fff;
}
.ekran {
  display:none;
  text-align:center;
  background:rgba(255,255,255,0.95);
  color:#333;
  padding:30px;
  border-radius:15px;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
  width:450px;
  max-width:90%;
  position:relative;
}
.aktif { display:block; }
input, button {
  padding:12px;
  margin:10px 0;
  width:80%;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}
button {
  background:#2575fc;
  color:white;
  cursor:pointer;
  font-weight:bold;
}
button:hover {
  background:#6a11cb;
  transform:scale(1.05);
}
#rol { font-size:24px; font-weight:bold; margin-top:20px; }
#kelime { font-size:28px; color:green; margin-top:15px; font-weight:bold; }
#oyuncular, #oySonucu {
  margin-top:20px;
  padding:0;
  list-style:none;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}
#oyuncular li, #oySonucu li {
  background:#2575fc;
  color:white;
  padding:8px 12px;
  margin:5px;
  border-radius:12px;
  font-weight:500;
  transition: transform 0.3s;
}
#oyuncular li:hover, #oySonucu li:hover { transform:scale(1.1); }
#baslatBtn { 
  position: fixed; 
  bottom: 140px; 
  left: 50%; 
  transform: translateX(-50%);
  display:none; 
  padding:12px 48px; 
  font-weight:bold; 
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color:white; 
  border-radius:12px; 
  border:none; 
  cursor:pointer; 
  box-shadow:0 4px 12px rgba(0,0,0,0.3); 
  transition: all 0.3s ease; 
  font-size:16px; 
  max-width:320px;
}
#baslatBtn:hover {
  transform: translateX(-50%) scale(1.05);
  box-shadow:0 6px 16px rgba(0,0,0,0.4);
}

/* Chat */
.chat {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  width: 260px;
  height: 400px;
  background: white;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}
.message {
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 12px;
  max-width: 70%;
  word-wrap: break-word;
}
.message.self {
  background: #2575fc;
  color: white;
  margin-left: auto;
  text-align: right;
}
.message.other {
  background: #e5e5ea;
  color: black;
  margin-right: auto;
  text-align: left;
}
#inputArea {
  display: flex;
  border-top: 1px solid #ccc;
}
#messageInput {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
}
#sendBtn {
  padding: 6px 10px;
  border-radius: 50%;
  font-size: 14px;
  font-weight: bold;
  background: #2575fc;
  color: white;
  border: none;
  cursor: pointer;
  margin: 5px;
  width: 36px;
  height: 36px;
}
#sendBtn:hover { background: #6a11cb; }
</style>
</head>
<body>
<div id="girisEkrani" class="ekran aktif">
  <h2>Kelime Oyunu</h2>
  <input id="isim" placeholder="İsminizi girin">
  <input id="odaKodu" placeholder="Oda kodu girin">
  <button onclick="odaKatil()">Odaya Katıl</button>
</div>

<div id="oyunEkrani" class="ekran">
  <h2>Rolünüz: <span id="rol"></span></h2>
  <div id="kelime"></div>
  <h3>Oyuncular</h3>
  <ul id="oyuncular"></ul>
  <h3>Oylama</h3>
  <ul id="oySonucu"></ul>
</div>

<!-- Chat başlangıçta gizli -->
<div id="chat" class="chat" style="display:none;">
  <div id="messages"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Mesaj yaz...">
    <button id="sendBtn">&gt;</button>
  </div>
</div>

<button id="baslatBtn" onclick="oyunuBaslat()">Oyunu Başlat</button>

<script>
const socket = io();
let odaKodu = "", isim = "";

function odaKatil(){
  isim = document.getElementById("isim").value.trim();
  odaKodu = document.getElementById("odaKodu").value.trim();
  if(!isim || !odaKodu){ alert("Lütfen isim ve oda kodu girin!"); return; }
  socket.emit("odaKatıl", {odaKodu, isim});
  document.getElementById("girisEkrani").classList.remove("aktif");
  document.getElementById("oyunEkrani").classList.add("aktif");
  document.getElementById("baslatBtn").style.display = "block";
  document.getElementById("chat").style.display = "flex";
}

function oyunuBaslat(){ socket.emit("oyunuBaslat", odaKodu); }

socket.on("rol", data => {
  document.getElementById("rol").innerText = data.rol;
  document.getElementById("rol").style.color = data.rol === "IMPOSTER" ? "red" : "blue";
  document.getElementById("kelime").innerText = data.kelime ? `Kelimeniz: ${data.kelime}` : "";
});

socket.on("oyuncuListesi", oyuncular => {
  const ul = document.getElementById("oyuncular");
  ul.innerHTML = "";
  oyuncular.forEach(o => {
    const li = document.createElement("li");
    li.textContent = o.isim;
    ul.appendChild(li);
  });

  const oyUl = document.getElementById("oySonucu");
  oyUl.innerHTML = "";
  oyuncular.forEach(o => {
    const li = document.createElement("li");
    li.innerHTML = `<input type="checkbox" class="oyCheckbox" data-id="${o.id}"> ${o.isim} - 0 oy`;
    oyUl.appendChild(li);
  });

  // Event listener'ları temizle ve yeniden ekle
  document.querySelectorAll(".oyCheckbox").forEach(cb => {
    cb.onclick = null; // Önceki event listener'ları temizle
    cb.addEventListener("click", e => {
      const secili = e.target;
      if(secili.checked){
        document.querySelectorAll(".oyCheckbox").forEach(c => {
          if(c !== secili) c.checked = false;
        });
        socket.emit("oyVer", {odaKodu, hedefId: secili.dataset.id});
      } else {
        socket.emit("oyVer", {odaKodu, hedefId: null});
      }
    });
  });
});

socket.on("oySonucu", ({oylar}) => {
  document.querySelectorAll("#oySonucu li").forEach(li => {
    const checkbox = li.querySelector("input");
    const id = checkbox.dataset.id;
    const oyuncuIsim = li.textContent.split('-')[0].trim();
    li.innerHTML = `<input type="checkbox" class="oyCheckbox" data-id="${id}"> ${oyuncuIsim} - ${oylar[id] || 0} oy`;
    
    // Checkbox durumunu koru
    li.querySelector("input").checked = checkbox.checked;
  });

  // Event listener'ları yeniden ekle
  document.querySelectorAll(".oyCheckbox").forEach(cb => {
    cb.onclick = null;
    cb.addEventListener("click", e => {
      const secili = e.target;
      if(secili.checked){
        document.querySelectorAll(".oyCheckbox").forEach(c => {
          if(c !== secili) c.checked = false;
        });
        socket.emit("oyVer", {odaKodu, hedefId: secili.dataset.id});
      } else {
        socket.emit("oyVer", {odaKodu, hedefId: null});
      }
    });
  });
});

// Hata mesajları
socket.on("hata", mesaj => {
  alert(mesaj);
});

// CHAT
document.getElementById("sendBtn").addEventListener("click", gonderMesaj);
document.getElementById("messageInput").addEventListener("keydown", e => {
  if(e.key === "Enter") gonderMesaj();
});

function gonderMesaj(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(text){
    socket.emit("chatMesaj", {odaKodu, isim, mesaj: text});
    input.value = "";
  }
}

socket.on("chatMesaj", ({isim: gonderen, mesaj}) => {
  const messages = document.getElementById("messages");
  const div = document.createElement("div");
  div.classList.add("message");
  if(gonderen === isim) div.classList.add("self");
  else div.classList.add("other");
  div.textContent = `${gonderen}: ${mesaj}`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
});
</script>
</body>
</html>
